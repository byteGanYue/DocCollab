 ğŸ˜Š å¯¼å¸ˆä»¬å¥½ï¼Œæˆ‘å«æ¸©æƒ å…°ï¼Œæ˜¯å¹¿ä¸œå·¥ä¸šå¤§å­¦2026å±Šçš„å­¦ç”Ÿã€‚ç›®å‰ï¼Œæˆ‘åœ¨æ»´æ»´ç½‘çº¦è½¦éƒ¨é—¨è¿›è¡Œå®ä¹ ï¼Œå¹¶ä¸”æ·±åº¦å‚ä¸äº†ä¸€å¥—åˆ›æ–°çš„å·¥ä½œå°ç ”å‘ä½“ç³»â€”â€”Misxä½“ç³»çš„åŸºç¡€è®¾æ–½å»ºè®¾ã€‚æˆ‘éå¸¸é«˜å…´èƒ½å¤Ÿå‚åŠ è¿™æ¬¡é£ä¹¦è®­ç»ƒè¥ï¼Œä¸‹é¢ä»‹ç»æˆ‘åœ¨æ­¤æ¬¡å¼€å‘é¡¹ç›®ä¸­è´Ÿè´£çš„æ ¸å¿ƒä»»åŠ¡ğŸ¥¬

------



# DocCollabååŒç¼–è¾‘ç³»ç»Ÿé¡¹ç›®ç­”è¾©ç¨¿ğŸ£



## ä¸€ã€å‚ä¸DocCollabé¡¹ç›®çš„ååŒç¼–è¾‘æ ¸å¿ƒæ¶æ„è®¾è®¡ğŸ§

   **åŒ…æ‹¬Yjs CRDTç®—æ³•é›†æˆã€WebSocketå®æ—¶é€šä¿¡ã€MongoDBæ•°æ®æŒä¹…åŒ–ç­‰å…³é”®æŠ€æœ¯é€‰å‹å’Œå®ç°ã€‚**

```jsx
æ ¸å¿ƒä»£ç 
é‡‡ç”¨Yjs CRDTç®—æ³•ä½œä¸ºååŒç¼–è¾‘çš„æ ¸å¿ƒå¼•æ“ï¼Œé€šè¿‡WebSocketå»ºç«‹å®æ—¶é€šä¿¡é€šé“ï¼Œå®ç°å¤šç”¨æˆ·ç¼–è¾‘æ“ä½œçš„è‡ªåŠ¨åŒæ­¥ã€‚å…·ä½“å®ç°åŒ…æ‹¬ï¼š
// ååŒç¼–è¾‘æ ¸å¿ƒæµç¨‹
const useCollaborativeEditor = (documentId) => {
  // 1. Yjsæ–‡æ¡£åˆå§‹åŒ–
  const ydoc = new Y.Doc();
  const ytext = ydoc.get('content', Y.XmlText);
  
  // 2. WebSocketå®æ—¶è¿æ¥
  const provider = new HocuspocusProvider(WS_URL, documentId, ydoc);
  
  // 3. åŒç­–ç•¥æŒä¹…åŒ–
  // å®šæ—¶ä»»åŠ¡ï¼šæ¯15åˆ†é’Ÿè‡ªåŠ¨ä¿å­˜
  // é‡å¤§äº‹ä»¶ï¼šæ–‡æ¡£å…³é—­ã€æ‰‹åŠ¨ä¿å­˜æ—¶è§¦å‘
};
```

**1.å‚ä¸ååŒæµæ ¸å¿ƒuseCollaborativeEditor Hook æ„å»ºï¼Œé€šè¿‡Yjs CRDTç®—æ³•å®ç°å¤šäººå®æ—¶åä½œï¼Œå®ç°100%è‡ªåŠ¨è§£å†³ååŒç¼–è¾‘å†²çª**

**2.å‚ä¸ååŒæ–‡æ¡£æ•°æ®æ‹‰å–åŒæ­¥çš„ä¼˜å…ˆçº§ç­–ç•¥è®¾è®¡ï¼šä¼˜å…ˆæ‹‰å–ååŒç¼–è¾‘çš„å®Œæ•´å¿«ç…§yjsState,åº”ç”¨åˆ°ååŒå®¹å™¨Y.Doc,MongoDBåŒæ­¥æœåŠ¡æ³¨å†Œã€‚å®ç°äº†ååŒæ•°æ®çš„åˆç†çš„å“åº”é€»è¾‘**

```jsx
// ä»useCollaborativeEditor.jsxçš„çœŸå®å®ç°
const historyRes = await fetch(`/api/document/${documentId}/history`);
if (historyRes.ok) {
  const historyData = await historyRes.json();
  const historyList = historyData?.data?.list || [];

  // è·å–æœ€æ–°ç‰ˆæœ¬çš„yjsState
  if (historyList.length > 0) {
    const latestVersion = historyList[0]; // æœ€æ–°ç‰ˆæœ¬
    yjsState = latestVersion?.yjsState;
    console.log('[Y.Doc Init] ä»å†å²ç‰ˆæœ¬è·å–yjsState:', {
      versionId: latestVersion?.id,
      yjsStateLength: yjsState?.length || 0,
    });
  }
}

// åˆå§‹åŒ–Y.Docå¹¶åº”ç”¨å†å²çŠ¶æ€
let ydoc = new Y.Doc();
if (yjsState && yjsState.length > 0) {
  try {
    Y.applyUpdate(ydoc, new Uint8Array(yjsState));
    console.log('[Y.Doc Init] æˆåŠŸåº”ç”¨yjsStateåˆ°Y.Doc');
  } catch (error) {
    console.error('[Y.Doc Init] åº”ç”¨yjsStateå¤±è´¥:', error);
  }
}
```

**3.å‚ä¸MongoDBåŒæ­¥æœåŠ¡çš„æœºåˆ¶å®ç°ï¼Œå®ç°äº†å‰ç«¯YjsååŒçŠ¶æ€ä¸åç«¯MongoDBæ•°æ®åº“æŒä¹…åŒ–å­˜å‚¨ä¹‹é—´æ•°æ®åŒæ­¥**

```jsx
// ç›‘å¬Yjsæ–‡æ¡£çš„å˜æ›´äº‹ä»¶
ydoc.on('update', (update, origin) => {
  // å½“ç”¨æˆ·ç¼–è¾‘æ–‡æ¡£æ—¶ï¼Œè‡ªåŠ¨è§¦å‘åŒæ­¥
  if (origin === 'network' || origin === 'mongodb-sync') {
    return; // é¿å…å¾ªç¯åŒæ­¥
  }
  
  this.log(`æ–‡æ¡£ ${documentId} å†…å®¹å‘ç”Ÿå˜æ›´`, { origin });
  this.scheduleSync(syncConfig, 'content-change'); // è°ƒåº¦åŒæ­¥ä»»åŠ¡
});

// é˜²æŠ–æœºåˆ¶ï¼Œé¿å…é¢‘ç¹åŒæ­¥
scheduleSync(syncConfig, reason) {
  const { documentId } = syncConfig;

  // æ¸…é™¤ä¹‹å‰çš„åŒæ­¥ä»»åŠ¡
  if (this.syncQueue.has(documentId)) {
    clearTimeout(this.syncQueue.get(documentId).timeoutId);
  }

  // åˆ›å»ºæ–°çš„åŒæ­¥ä»»åŠ¡ï¼Œå»¶è¿Ÿ1ç§’æ‰§è¡Œ
  const syncTask = {
    syncConfig,
    reason,
    scheduledTime: Date.now(),
    timeoutId: setTimeout(() => {
      this.executeSyncTask(documentId);
    }, this.options.syncDelay), // é»˜è®¤1000mså»¶è¿Ÿ
  };

  this.syncQueue.set(documentId, syncTask);
}
```

**ç»“æœï¼š**

1. **ä¸‰å±‚åŒæ­¥æ¶æ„ï¼š**æœ¬åœ°çŠ¶æ€ â†’ WebSocketå®æ—¶åŒæ­¥ â†’ æ•°æ®åº“æŒä¹…åŒ–

2. **æ‰“é€šååŒå…¨é“¾è·¯**ï¼šå®ç°äº†ç”¨æˆ·ç¼–è¾‘æ–‡æ¡£ â†’ Yjsæ£€æµ‹åˆ°å˜æ›´è½¬æ¢ä¸ºCRDTæ“ä½œ ï¼Œè§¦å‘åŒæ­¥ä»»åŠ¡->WebSocketå‘é€åˆ°æœåŠ¡å™¨ â†’ æœåŠ¡å™¨å¹¿æ’­ç»™æ‰€æœ‰ç”¨æˆ·çš„ååŒå…¨é“¾è·¯èƒ½åŠ›

3. **å®¹é”™æœºåˆ¶ï¼š**æ”¯æŒæ–­ç½‘é‡è¿å’Œå¼‚å¸¸æ¢å¤

   ------

   

## äºŒã€å‚ä¸å†å²ç‰ˆæœ¬çŸ­æœŸå­˜å‚¨ç®¡ç†ä»¥åŠé•¿æœŸå½’æ¡£ç®¡ç†ğŸ¼

**è®¾è®¡å¹¶å®ç°æ–‡æ¡£å†å²ç‰ˆæœ¬ç®¡ç†ç³»ç»Ÿï¼ŒåŒ…æ‹¬ç‰ˆæœ¬æ•°æ®ç»“æ„è®¾è®¡ã€è‡ªåŠ¨ä¿å­˜æœºåˆ¶ã€ç‰ˆæœ¬æ¸…ç†ç­–ç•¥ç­‰æ ¸å¿ƒåŠŸèƒ½å¼€å‘ã€‚**

**ç›®æ ‡è€ƒè™‘ä¼ä¸šçº§æ–‡æ¡£å½’æ¡£å­˜å‚¨éœ€æ±‚**

**å­˜å‚¨ç­–ç•¥**

1.çŸ­æœŸå­˜å‚¨ (MongoDB)ã€æœ€è¿‘30å¤©çš„å†å²ç‰ˆæœ¬å¿«é€Ÿæ¢å¤å’ŒæŸ¥è¯¢

2.é•¿æœŸå­˜å‚¨ (æ–‡ä»¶ç³»ç»Ÿ)ã€30å¤©å‰çš„å†å²ç‰ˆæœ¬å½’æ¡£ï¼ˆæŒ‰æ–‡æ¡£IDåˆ†ç»„å­˜å‚¨ï¼‰

### æ ¸å¿ƒå®ç°æ–¹æ³•

åŸºäºMongoDBè®¾è®¡å†å²ç‰ˆæœ¬æ•°æ®æ¨¡å‹ã€‚å…·ä½“å®ç°åŒ…æ‹¬ï¼š

**1.å¿«ç…§å­˜å‚¨ç­–ç•¥**

```jsx
// å†å²ç‰ˆæœ¬æ•°æ®ç»“æ„
{
 _id: ObjectId,
 documentId: String,  // æ–‡æ¡£å”¯ä¸€æ ‡è¯†
 versionId: Number,   // ç‰ˆæœ¬å·
 content: String,    // å†…å®¹å¿«ç…§
 yjsState: Binary,   // ååŒçŠ¶æ€å¿«ç…§
 create_time: Date,   // åˆ›å»ºæ—¶é—´
 create_username: String // åˆ›å»ºè€…
}
// å†å²ç‰ˆæœ¬å½’æ¡£è¡¨æ•°æ®ç»“æ„
{
 versionId: 1,
 documentId: 123,
 content: "æ–‡æ¡£å†…å®¹",
 yjsState: [1, 2, 3, ...], // YjsçŠ¶æ€å¿«ç…§
 restoreFromVersionId: null, // å›æº¯æ¥æº
 create_time: "2024-01-01T00:00:00Z"
}
```



**2.å½’æ¡£ç®¡ç†å®ç°ï¼ˆæ‰‹åŠ¨å½’æ¡£ã€ è‡ªåŠ¨å½’æ¡£æœåŠ¡ï¼‰**

```jsx
@Cron('0 3 * * *') // æ¯å¤©å‡Œæ™¨3ç‚¹
async archiveOldSnapshots() {
  const THIRTY_DAYS_AGO = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);

  // æŸ¥è¯¢30å¤©å‰çš„å¿«ç…§
  const oldSnapshots = await this.documentHistoryModel.find({
    create_time: { $lt: THIRTY_DAYS_AGO }
  });

  // å¯¼å‡ºåˆ°æœ¬åœ°æ–‡ä»¶
  for (const [docId, versions] of docMap.entries()) {
    const filePath = `./archive/document-history-${docId}.json`;
    fs.writeFileSync(filePath, JSON.stringify({ versions }));
  }
}
```

------



## ä¸‰ã€å‚ä¸æ™ºèƒ½å›æ»šç³»ç»Ÿæ¶æ„è®¾è®¡ğŸ‘€

**è´Ÿè´£æ™ºèƒ½å›æ»šç³»ç»Ÿçš„æ¶æ„è®¾è®¡å’Œæ ¸å¿ƒç®—æ³•å®ç°ï¼ŒåŒ…æ‹¬åŸå­åŒ–å›æ»šæœºåˆ¶ã€æ“ä½œå‹ç¼©ç®—æ³•ã€å…¨å±€çŠ¶æ€åŒæ­¥ç­‰å…³é”®æŠ€æœ¯å¼€å‘ã€‚**

### æ ¸å¿ƒå®ç°æ–¹æ³•

é‡‡ç”¨Y.applyUpdate()å®ç°çŠ¶æ€å›æ»šï¼Œè®¾è®¡åŸå­åŒ–æ“ä½œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼Œé€šè¿‡æ“ä½œå‹ç¼©æå‡å›æ»šæ€§èƒ½ã€‚å…·ä½“å®ç°åŒ…æ‹¬ï¼š

```jsx
// æ™ºèƒ½å›æ»šæ‰§è¡Œæµç¨‹
const restoreFromSnapshot = async (snapshot) => {
  // 1. ç”¨æˆ·é€‰æ‹©ç›®æ ‡ç‰ˆæœ¬ï¼ˆæ”¯æŒæ—¶é—´è½´é¢„è§ˆï¼‰
  // 2. å‰ç«¯å‘èµ·å›æ»šè¯·æ±‚
  // 3. æœåŠ¡ç«¯åŠ è½½ç›®æ ‡yjsState
  // 4. å‰ç«¯ç”¨Y.applyUpdate(doc, yjsState)å®ç°çŠ¶æ€å›æ»š
  // 5. ååŒç³»ç»Ÿè‡ªåŠ¨å¹¿æ’­çŠ¶æ€æ›´æ–°
  
  provider.disconnect();
  Y.applyUpdate(ydoc, snapshot.yjsState);
  provider.connect();
  provider.sync();
};
```

### 1. åŸå­åŒ–å›æ»šæœºåˆ¶å®ç°

**æš‚åœååŒ â†’ åº”ç”¨å¿«ç…§ â†’ æ¢å¤ååŒï¼Œä»¥åŠå¿«ç…§åº”ç”¨æ˜¯å¦æˆåŠŸçš„éªŒè¯æœºåˆ¶**

```jsx
const restoreFromSnapshot = async (snapshot) => {
  // 1. è®¾ç½®åŸå­åŒ–æ ‡å¿—ï¼Œé˜²æ­¢å¹¶å‘æ“ä½œ
  window.isRestoringSnapshot = true;
  try {
    // 2. æš‚åœååŒç¼–è¾‘ï¼Œç¡®ä¿çŠ¶æ€ä¸€è‡´æ€§
    if (window.provider) {
      window.provider.disconnect();
    }
    // 3. åº”ç”¨å¿«ç…§åˆ°Y.Doc
    const update = new Uint8Array(snapshot);
    Y.applyUpdate(window.ydoc, update);
    console.log('[å›æ»š] å¿«ç…§åº”ç”¨æˆåŠŸ');
      
    // 4. å¼ºåˆ¶åŒæ­¥åˆ°æ‰€æœ‰å®¢æˆ·ç«¯
    if (window.provider) {
      await window.provider.flush();
      console.log('[å›æ»š] provider.flush() å®Œæˆï¼Œå·²æ¨é€æœ¬åœ°Y.Docåˆ°æœåŠ¡å™¨');
    }
    // 5. é‡æ–°è¿æ¥ï¼Œæ¢å¤ååŒ
    if (window.provider) {
      window.provider.connect();
      console.log('[å›æ»š] å·²é‡è¿providerï¼Œæ¢å¤ååŒ');
    }
  } finally {
    // 6. æ¸…é™¤åŸå­åŒ–æ ‡å¿—
    window.isRestoringSnapshot = false;
  }
};
```

**ç»“æœï¼š**

**æ•°æ®ä¸€è‡´æ€§**ï¼š100%ä¿è¯æ‰€æœ‰å®¢æˆ·ç«¯çœ‹åˆ°ç›¸åŒçš„å›æ»šç»“æœ

**æ“ä½œå®‰å…¨æ€§ï¼š**é˜²æ­¢å›æ»šè¿‡ç¨‹ä¸­çš„å¹¶å‘ç¼–è¾‘å†²çª

**ç”¨æˆ·ä½“éªŒ**ï¼šå›æ»šè¿‡ç¨‹å¯¹ç”¨æˆ·é€æ˜ï¼Œæ— æ„ŸçŸ¥åˆ‡æ¢

### 2ã€ä½¿ç”¨Yjsçš„çŠ¶æ€å¿«ç…§ï¼ˆState Snapshotï¼‰æœºåˆ¶å®ç°å½’æ»šä¸­çš„æ“ä½œå‹ç¼©

```jsx
const createHistoryVersion = useCallback(async () => {
  try {
    const content = JSON.stringify(editorValue);
    let yjsState = undefined;
    if (window.ydoc && window.Y) {
      // è·å–Yjsæ–‡æ¡£çš„äºŒè¿›åˆ¶çŠ¶æ€ - è¿™å°±æ˜¯æ“ä½œå‹ç¼©çš„æ ¸å¿ƒ
      yjsState = Array.from(window.Y.encodeStateAsUpdate(window.ydoc));
    }
    // ä¿å­˜å‹ç¼©åçš„çŠ¶æ€åŒ…
    const result = await documentAPI.createDocumentHistory(
      documentId,
      content,
      yjsState, // å‹ç¼©åçš„çŠ¶æ€åŒ…
    );
  } catch (error) {
    console.error(`[DocEditor] å†å²ç‰ˆæœ¬åˆ›å»ºå¤±è´¥:`, error);
  }
}, [documentId, currentVersionId, editorValue]);

//æ“ä½œè§£å‹ç¼©çš„å®ç°
const restoreFromSnapshot = async (snapshot) => {
  try {
    // 1. å°†å‹ç¼©çš„æ“ä½œçŠ¶æ€è½¬æ¢ä¸ºUint8Array
    const update = new Uint8Array(snapshot);
    
    // 2. åº”ç”¨æ“ä½œåºåˆ—åˆ°Y.Doc
    Y.applyUpdate(window.ydoc, update);
    
    // 3. Y.Docä¼šæ ¹æ®æ“ä½œåºåˆ—é‡å»ºå†…å®¹
    const yText = window.ydoc.get('content', Y.XmlText);
    console.log('é‡å»ºåçš„å†…å®¹:', yText.toString());
    
  } catch (error) {
    console.error('[DocEditor] åº”ç”¨å¿«ç…§å¤±è´¥:', error);
  }
};
```

**ç»“æœï¼š**

**ä¼ è¾“æ•ˆç‡æå‡90%ï¼š**ä¸‡çº§æ“ä½œå‹ç¼©ä¸ºå•ä¸ªçŠ¶æ€åŒ…ï¼Œå®ç°ç½‘ç»œä¼ è¾“æ—¶é—´é™çº§ï¼Œå¸¦å®½æ¶ˆè€—å‡å°‘

**å­˜å‚¨ç©ºé—´ä¼˜åŒ–60%ï¼š**çŠ¶æ€åŒ…æ¯”åŸå§‹æ“ä½œæ•°æ®å°å¾—å¤šï¼Œæ•°æ®åº“å­˜å‚¨ç©ºé—´å¤§å¹…å‡å°‘ï¼Œå†å²ç‰ˆæœ¬åŠ è½½é€Ÿåº¦æå‡

**æ¢å¤é€Ÿåº¦æå‡ï¼š**å•ä¸ªçŠ¶æ€åŒ…åº”ç”¨æ¯”é€ä¸ªæ“ä½œæ¢å¤å¿«ï¼ŒåŸå­åŒ–æ“ä½œï¼Œé¿å…ä¸­é—´çŠ¶æ€

------



## å››ã€ä¸»å¯¼ç¼–è¾‘å™¨SDKå‘åŒ…github packageä¸GitHub Actionsè‡ªåŠ¨åŒ–éƒ¨ç½²æµæ°´çº¿ğŸ¥¬

- **GitHub Packages è‡ªåŠ¨å‘åŒ…**ï¼šä¸»å¯¼å®ç°ç¼–è¾‘å™¨ SDK çš„å‘åŒ…æµç¨‹ï¼Œæ”¯æŒé€šè¿‡ Git æ ‡ç­¾ï¼ˆtagï¼‰è§¦å‘è‡ªåŠ¨å‘åŒ…åˆ° GitHub Packagesã€‚
- **GitHub Actions è‡ªåŠ¨åŒ–éƒ¨ç½²**ï¼šæ„å»ºå¹¶ä¼˜åŒ– GitHub Actions è‡ªåŠ¨åŒ–éƒ¨ç½²æµæ°´çº¿ï¼Œå®ç°ä»ä»£ç æäº¤åˆ°è‡ªåŠ¨å‘å¸ƒçš„å…¨æµç¨‹è‡ªåŠ¨åŒ–ã€‚

**ç»“æœï¼š**æ¨åŠ¨ç‰ˆæœ¬ç®¡ç†çš„è§„èŒƒåŒ–ï¼Œæå‡å›¢é˜Ÿåä½œæ•ˆç‡ã€‚ä¸ºåé¢æ¸è¿›å¼é›†æˆï¼Œé¡¹ç›®å¤ç”¨ï¼Œå¯æ‰©å±•å®šåˆ¶åŒ–éœ€æ±‚å¥ å®šåŸºç¡€ã€‚

------



## äº”ã€å®ç°å¤šä¸»é¢˜å“åº”å¼æ ·å¼é…ç½®ğŸ•Šï¸

**ç»“æœï¼š**

**å®ç°å¤šä¸»é¢˜åˆ‡æ¢ã€å“åº”å¼æ ·å¼é€‚é…ä¸åŒçš„å±å¹•å°ºå¯¸ï¼Œç»Ÿä¸€çš„ç»„ä»¶æ ·å¼é£æ ¼**

**æ³¨é‡ç”¨æˆ·çš„äº§å“ä½“éªŒï¼Œæå‡äº§å“çš„è¾¨è¯†åº¦å’Œç«äº‰åŠ›**

```jsx
/* å“åº”å¼æ ·å¼ - å¹³æ¿è®¾å¤‡ */
@media (max-width: 768px) {
  .container {
    padding: 16px;
  }
  .title {
    font-size: 20px;
  }
  /* åœ¨å°å±å¹•ä¸Šéšè—éƒ¨åˆ†åˆ—ä»¥èŠ‚çœç©ºé—´ */
  .table :global(.ant-table-thead) th:nth-child(3),
  .table :global(.ant-table-tbody) td:nth-child(3) {
    display: none;
  }
}
/* å“åº”å¼æ ·å¼ - æ‰‹æœºè®¾å¤‡ */
@media (max-width: 480px) {
  .container {
    padding: 12px;
  }
  .title {
    font-size: 18px;
    margin-bottom: 12px;
  }
  /* åœ¨æ‰‹æœºä¸Šè¿›ä¸€æ­¥ç®€åŒ–è¡¨æ ¼æ˜¾ç¤º */
  .table :global(.ant-table-thead) th:nth-child(2),
  .table :global(.ant-table-tbody) td:nth-child(2),
  .table :global(.ant-table-thead) th:nth-child(3),
  .table :global(.ant-table-tbody) td:nth-child(3) {
    display: none;
  }
}
```

