# DocCollab 系统架构设计

本文档详细描述了DocCollab系统的技术架构、组件设计和数据流。

## 系统整体架构

DocCollab采用现代前后端分离的微服务架构，包含以下核心组件：

```
                  ┌─────────────┐
                  │  客户端浏览器 │
                  └─────┬───────┘
                        │
                        ▼
┌─────────────────────────────────────────┐
│             前端应用 (doc-web)           │
│                                         │
│  ┌──────────┐  ┌──────────┐ ┌─────────┐ │
│  │   React   │  │  Router  │ │ Contexts│ │
│  └──────────┘  └──────────┘ └─────────┘ │
│                                         │
│  ┌──────────┐  ┌──────────┐ ┌─────────┐ │
│  │  编辑器   │  │ 状态管理  │ │  API调用 │ │
│  └──────────┘  └──────────┘ └─────────┘ │
└───────────────────┬─────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│             后端服务 (doc-server)         │
│                                         │
│  ┌──────────┐  ┌──────────┐ ┌─────────┐ │
│  │  NestJS  │  │ 控制器层  │ │ 服务层  │ │
│  └──────────┘  └──────────┘ └─────────┘ │
│                                         │
│  ┌──────────┐  ┌──────────┐ ┌─────────┐ │
│  │ 数据模型  │  │ WebSocket│ │ 认证授权 │ │
│  └──────────┘  └──────────┘ └─────────┘ │
└───────────────────┬─────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│             数据存储层                   │
│                                         │
│  ┌──────────┐  ┌──────────┐             │
│  │ MongoDB  │  │   缓存    │             │
│  └──────────┘  └──────────┘             │
│                                         │
└─────────────────────────────────────────┘
```

## 前端架构 (doc-web)

### 核心技术栈

- **框架**: React 19
- **路由**: React Router 7
- **UI组件**: Ant Design 5
- **状态管理**: React Context API + 自定义Hooks
- **构建工具**: Vite 6

### 主要模块

1. **认证模块**
   - 登录/注册表单
   - JWT认证
   - 权限控制

2. **文档管理**
   - 文件夹树
   - 最近访问
   - 文档搜索

3. **编辑器集成**
   - 富文本编辑
   - 协同功能
   - 评论系统

4. **用户界面**
   - 响应式布局
   - 主题定制
   - 多语言支持（预留）

### 状态管理

采用React Context API和自定义Hooks模式管理全局状态：

```jsx
// 用户上下文示例
const UserContext = createContext();

export const UserProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  
  // 用户认证逻辑...
  
  return (
    <UserContext.Provider value={{ user, loading, login, logout }}>
      {children}
    </UserContext.Provider>
  );
};

// 使用自定义Hook简化状态访问
export const useAuth = () => useContext(UserContext);
```

## 编辑器架构 (doc-editor)

### 核心技术栈

- **编辑框架**: Slate.js
- **协同算法**: Yjs
- **通信协议**: WebSocket

### 协同编辑实现

DocCollab的核心功能是实时协同编辑，基于CRDT算法实现：

1. **本地编辑处理**：
   - 捕获用户输入
   - 应用转换到本地文档模型
   - 生成操作记录

2. **远程同步**：
   - 通过WebSocket传输操作
   - 合并远程操作到本地模型
   - 解决冲突并保持一致性

3. **光标同步**：
   - 广播用户光标位置
   - 实时显示多用户光标
   - 使用颜色区分不同用户

### 数据流

```
┌────────────┐    ┌────────────┐    ┌────────────┐
│  用户输入   │───▶│ Slate编辑器 │───▶│ Yjs文档   │
└────────────┘    └────────────┘    └─────┬──────┘
                                          │
                                          ▼
┌────────────┐    ┌────────────┐    ┌────────────┐
│ 其他用户UI  │◀───│ Slate更新  │◀───│ WebSocket  │
└────────────┘    └────────────┘    └────────────┘
```

## 后端架构 (doc-server)

### 核心技术栈

- **框架**: NestJS 11
- **数据库**: MongoDB
- **WebSocket**: Socket.IO
- **认证**: JWT

### 模块设计

1. **用户模块**
   - 注册/登录
   - 权限管理
   - 用户配置

2. **文档模块**
   - 文档CRUD
   - 版本历史
   - 协作管理

3. **文件夹模块**
   - 层级结构
   - 权限控制
   - 组织管理

4. **WebSocket模块**
   - 实时通信
   - 操作广播
   - 状态同步

### API设计

采用RESTful风格API：

- `/api/v1/users` - 用户相关操作
- `/api/v1/documents` - 文档操作
- `/api/v1/folders` - 文件夹操作

WebSocket事件：

- `document:update` - 文档内容更新
- `cursor:move` - 光标位置更新
- `comment:add` - 新增评论
- `user:join` - 用户加入编辑

## 数据模型

### 用户模型

```typescript
interface User {
  _id: string;
  username: string;
  email: string;
  password: string; // 加密存储
  avatar?: string;
  createdAt: Date;
  updatedAt: Date;
}
```

### 文档模型

```typescript
interface Document {
  _id: string;
  title: string;
  content: any; // Yjs文档数据
  folderId?: string; // 父文件夹ID
  createdBy: string; // 用户ID
  createdAt: Date;
  updatedAt: Date;
  permissions: Permission[];
}
```

### 文件夹模型

```typescript
interface Folder {
  _id: string;
  name: string;
  parentId?: string; // 父文件夹ID
  createdBy: string; // 用户ID
  createdAt: Date;
  updatedAt: Date;
  permissions: Permission[];
}
```

## 部署架构

DocCollab支持多种部署方式：

1. **开发环境**: 本地部署，单机运行
2. **测试环境**: Docker容器化部署
3. **生产环境**: Kubernetes集群部署

生产环境部署架构：

```
            ┌─────────────┐
            │   Nginx     │
            └──────┬──────┘
                   │
           ┌───────┴───────┐
           ▼               ▼
┌─────────────────┐ ┌─────────────────┐
│ Front-end Pod   │ │ Front-end Pod   │
└─────────────────┘ └─────────────────┘
           ┌───────┴───────┐
           ▼               ▼
┌─────────────────┐ ┌─────────────────┐
│ Back-end Pod    │ │ Back-end Pod    │
└─────────────────┘ └─────────────────┘
           │               │
           └───────┬───────┘
                   ▼
         ┌─────────────────┐
         │ MongoDB Cluster │
         └─────────────────┘
```

## 扩展性设计

DocCollab采用模块化设计，具有良好的扩展性：

1. **插件系统**: 支持扩展编辑器功能
2. **主题定制**: 支持自定义UI主题
3. **API扩展**: 后端API支持版本管理和扩展
4. **微服务拆分**: 核心功能可拆分为独立服务
5. **国际化**: 支持多语言界面

## 性能优化

1. **前端优化**:
   - 代码分割和懒加载
   - 虚拟列表渲染
   - 缓存策略

2. **后端优化**:
   - 数据库索引优化
   - 缓存热门文档
   - WebSocket连接池管理

3. **协同编辑优化**:
   - 差量同步
   - 操作批处理
   - 并发控制 